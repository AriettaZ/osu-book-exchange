<h1>Dashboard#messages</h1>
<p>Find me in app/views/dashboard/messages.html.erb</p>

<%= form_tag(dashboard_messages_path, :method=>"get") do %>
	<%= hidden_field_tag(:talk_to, params[:talk_to]) %>
	<%= submit_tag("Refresh") %>
<% end %>

<button id="ajax_refresh">Ajax Refresh</button>

<div class="">
<h1><%= @msg %></h1>
<% @messages.each do |message| %>
		<!-- <div><%= message.inspect %></div> -->
	<div class="showed-message">
		<%= hidden_field_tag nil ,message.created_at.to_s(:db), class: "created-time" %>
		Time: <%= message.created_at %>
		<br/>
		Content: <%= message.content %>
		<br/>
		Sender: <%= message.sender_id %>
		<br/>
		Receiver: <%= message.receiver_id %>
		<br/><br/>
	</div>
<% end %>

<p><%= @msg2 %></p>

<form>
	<input type="text" name="" id="user-chat-input" placeholder="Enter your message here."/>
	<!-- <button type="submit" id="user-chat-submit">Send</button> -->
	<div id="user-chat-submit">Send</div>
</form>

<script>
	$(document).ready(function(){
		$("#ajax_refresh").click(function(){
			$.ajax({
				url: window.location.href+"&last_msg_time="+$('.showed-message').last().find('.created-time').val(),

			}).done(function(data){
				$('.showed-message').last().after(data)
			})
		})

		// setInterval(function(){
		// 	$.ajax({
		// 		url: window.location.href+"&last_msg_time="+$('.showed-message').last().find('.created-time').val(),

		// 	}).done(function(data){
		// 		$('.showed-message').last().after(data)
		// 	})
		// }, 5000)

		$('#user-chat-input').keydown(function(event){
			if(event.which==13){
				event.preventDefault();
				$('#user-chat-submit').trigger("click");
			}
		})

		$('#user-chat-submit').click(function(){
			if($('#user-chat-input').val().length>=1){

				$.ajax({
					method: "POST",
					type: "POST",
					url: window.location.href.split('?')[0],
					data:{
						"talk_to": "<%= params[:talk_to]%>",
						"post_id": "<%= params[:post_id]%>",
						"content": $('#user-chat-input').val(),
						"authenticity_token": $('meta[name=csrf-token]').attr('content'),
						"last_msg_time": $('.showed-message').last().find('.created-time').val()
					}
				}).done(function(data){
					$('.showed-message').last().after(data)
					$('#user-chat-input').val("")
					$('#user-chat-input').focus()
				})
			}else{
				$('#user-chat-input').attr("placeholder", "Can't send Blank message.")
			}
		})

	})
</script>




<%= form_for @message, url: dashboard_messages_path(talk_to: params[:talk_to], post_id: params[:post_id]), method: "post" do |f| %>
	<%= f.text_area :content, size: "60x12" %>
	<%= f.submit("Send") %>
<% end %>

</div>